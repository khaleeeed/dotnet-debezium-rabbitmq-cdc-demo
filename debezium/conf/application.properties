# Debezium Server Configuration
debezium.sink.type=rabbitmq
debezium.source.connector.class=io.debezium.connector.sqlserver.SqlServerConnector

# SQL Server Configuration
debezium.source.database.hostname=sqlserver
debezium.source.database.port=1433
debezium.source.database.user=sa
debezium.source.database.password=YourPassword123!
debezium.source.database.dbname=BookingSystem
debezium.source.database.encrypt=false

# Connector Configuration
debezium.source.database.server.name=sqlserver-cdc
debezium.source.table.include.list=dbo.booking,dbo.package,dbo.applicant
debezium.source.schema.history.internal=io.debezium.storage.file.history.FileSchemaHistory
debezium.source.schema.history.internal.file.filename=/debezium/data/schema-history.dat

debezium.source.offset.storage=file
debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat

# RabbitMQ Configuration
debezium.sink.rabbitmq.connection.host=rabbitmq
debezium.sink.rabbitmq.connection.port=5672
debezium.sink.rabbitmq.connection.username=guest
debezium.sink.rabbitmq.connection.password=guest
debezium.sink.rabbitmq.exchange.name=debezium.cdc.events
debezium.sink.rabbitmq.exchange.durable=true
debezium.sink.rabbitmq.exchange.type=direct
debezium.sink.rabbitmq.routing.key=cdc.events

# Transforms Configuration for Content-Based Routing
debezium.transforms=unwrap,route
debezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState
debezium.transforms.unwrap.drop.tombstones=false
debezium.transforms.unwrap.delete.handling.mode=drop

# Content-Based Router Transform
debezium.transforms.route.type=io.debezium.transforms.ContentBasedRouter
debezium.transforms.route.language=jsr223.groovy
debezium.transforms.route.topic.expression=
  if (value.after == null) return null;
  
  String tableName = value.source.table;
  
  # Applicant events go to fanout exchange
  if (tableName == "applicant") {
    return "applicant.fanout";
  }
  
  # Package events routing based on status
  if (tableName == "package") {
    def status = value.after?.status;
    if (status == 3) {
      return "publishedpackagequeue";
    } else if (status == 5) {
      return "canceledpackagequeue";
    }
  }
  
  # Booking events and other package events go to default queue
  if (tableName == "booking") {
    return "booking.events";
  }
  
  return "default.cdc.events";

# Configure the RabbitMQ routing based on transformed topic
debezium.sink.rabbitmq.routing.key.field=destination-topic