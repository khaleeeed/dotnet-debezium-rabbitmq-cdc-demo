@page
@model CdcDashboard.Pages.BookingsModel
@{
    ViewData["Title"] = "Bookings";
    ViewData["Subtitle"] = "Status flows  realtime";
}

<div x-data="bookingsApp()" x-init="init()">
    <!-- KPIs -->
    <section class="grid grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-2xl p-4 shadow">
            <div class="text-xs text-slate-400">Bookings Today</div>
            <div class="text-2xl font-semibold" x-text="kpi.today"></div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow">
            <div class="text-xs text-slate-400">Revenue (today)</div>
            <div class="text-2xl font-semibold" x-text="kpi.revenue"></div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow">
            <div class="text-xs text-slate-400">Pending</div>
            <div class="text-2xl font-semibold" x-text="kpi.pending"></div>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow">
            <div class="text-xs text-slate-400">Confirmed</div>
            <div class="text-2xl font-semibold" x-text="kpi.confirmed"></div>
        </div>
    </section>

    <!-- charts + stream -->
    <section class="grid grid-cols-8 gap-6">
        <div class="col-span-5 bg-white rounded-2xl p-4 shadow">
            <h2 class="text-sm font-semibold mb-3">Status distribution (last 7 days)</h2>
            <canvas id="statusChart" height="160"></canvas>

            <div class="mt-4">
                <h3 class="text-sm font-semibold mb-2">Status Flow (last 24h)</h3>
                <div class="flex items-center gap-2">
                    <div class="flow-bar" style="width:35%; background:#FDE68A"></div>
                    <div class="flow-bar" style="width:45%; background:#60A5FA"></div>
                    <div class="flow-bar" style="width:20%; background:#FCA5A5"></div>
                    <div class="text-xs text-slate-400 ml-3">Pending  Confirmed  Cancelled</div>
                </div>
            </div>
        </div>

        <div class="col-span-3 bg-white rounded-2xl p-4 shadow max-h-[62vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-semibold">Recent Booking Events</h3>
                <button class="text-xs px-3 py-1 rounded bg-slate-100" @@click="pushDemo()">Push demo</button>
            </div>

            <template x-for="b in events" :key="b.uid">
                <div class="p-3 mb-3 rounded-lg border flex justify-between items-start transition hover:shadow" @@click="selected = b">
                    <div class="w-3/4">
                        <div class="text-sm font-medium" x-text="''#'' + b.id + ''  '' + b.action"></div>
                        <div class="text-xs text-slate-400" x-text="b.time"></div>

                        <div class="mt-2 text-xs">
                            <span class="text-slate-500">Status:</span>
                            <span class="ml-2 font-semibold" x-text="b.status"></span>
                            <span class="ml-3 text-slate-400">Amount: $<span x-text="b.amount"></span></span>
                        </div>

                        <div class="mt-2" x-show="b.changes && Object.keys(b.changes).length">
                            <div class="text-xs text-amber-700">Changed:</div>
                            <div class="text-xs mt-1">
                                <template x-for="(c,k) in b.changes" :key="k">
                                    <div class="text-xs"><b x-text="k"></b>: <span class="line-through text-slate-400" x-text="c[0]"></span>  <span class="font-medium" x-text="c[1]"></span></div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="text-right text-xs">
                        <div class="mb-2">
                            <span class="px-2 py-1 rounded-full text-white text-xs" :class="b.status===''Confirmed''?''bg-indigo-600'':(b.status===''Pending''?''bg-amber-500'':''bg-rose-500'')" x-text="b.status"></span>
                        </div>
                        <div class="text-slate-400" x-text="timeAgo(b.ts)"></div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- detail panel -->
    <section class="mt-6 bg-white p-4 rounded-2xl shadow" x-show="selected" x-transition>
        <div class="flex justify-between items-center">
            <div>
                <h3 class="font-semibold">Booking Detail  <span x-text="''#'' + selected?.id"></span></h3>
                <div class="text-xs text-slate-400" x-text="selected?.time"></div>
            </div>
            <div>
                <button class="text-xs px-3 py-1 rounded bg-slate-100" @@click="selected=null">Close</button>
            </div>
        </div>

        <div class="mt-3 grid grid-cols-3 gap-4" x-show="selected">
            <div>
                <div class="text-xs text-slate-400">Applicant</div>
                <div class="font-medium" x-text="selected?.applicant"></div>
            </div>
            <div>
                <div class="text-xs text-slate-400">Package</div>
                <div class="font-medium" x-text="selected?.package?.name"></div>
            </div>
            <div>
                <div class="text-xs text-slate-400">Amount</div>
                <div class="font-medium" x-text="''$'' + selected?.amount"></div>
            </div>
        </div>

        <div class="mt-4" x-show="selected">
            <h4 class="text-sm font-semibold">Status Timeline</h4>
            <div class="mt-2 flex gap-2">
                <template x-for="s in selected?.history || []" :key="s.status">
                    <div class="p-2 rounded-lg bg-slate-50 text-xs shadow" :class="s.status===''Confirmed''?''bg-indigo-50'':''''">
                        <div class="font-medium" x-text="s.status"></div>
                        <div class="text-xs text-slate-400" x-text="s.time"></div>
                    </div>
                </template>
            </div>
        </div>
    </section>
</div>

@section Scripts {
<script>
    function bookingsApp() {
        return {
            events: [],
            selected: null,
            kpi: { today: 142, revenue: ''$12,450'', pending: 38, confirmed: 90 },
            chart: null,
            connection: null,

            init() {
                this.seed();
                this.renderChart();
                this.setupSignalR();
                setInterval(() => this.pushDemo(), 3000);
            },

            setupSignalR() {
                this.connection = new signalR.HubConnectionBuilder()
                    .withUrl(''/cdcHub'')
                    .withAutomaticReconnect()
                    .build();

                this.connection.on(''BookingEvent'', (evt) => {
                    const b = this.makeBookingEvent(
                        evt.id,
                        evt.type,
                        evt.after?.statusName || ''Pending'',
                        evt.after?.amount || 0,
                        evt.changes || {}
                    );
                    this.events.unshift(b);
                    if (this.events.length > 50) this.events.pop();
                });

                this.connection.start().catch(err => console.error(err));
            },

            seed() {
                this.events = [
                    this.makeBookingEvent(9821, ''Update'', ''Confirmed'', 150, { BookingStatus: [1, 2] }),
                    this.makeBookingEvent(9814, ''Create'', ''Pending'', 50),
                    this.makeBookingEvent(9802, ''Update'', ''Cancelled'', 0, { BookingStatus: [2, 0] })
                ];
            },

            pushDemo() {
                const id = Math.floor(Math.random() * 9000) + 9000;
                const statuses = [''Pending'', ''Confirmed'', ''Cancelled''];
                const st = statuses[Math.floor(Math.random() * statuses.length)];
                const ev = this.makeBookingEvent(id, (Math.random() > 0.5 ? ''Create'' : ''Update''), st, Math.floor(Math.random() * 400) + 10);
                this.events.unshift(ev);
                if (this.events.length > 50) this.events.pop();
                this.selected = ev;
                setTimeout(() => this.selected = null, 4000);
                this.updateChartData();
            },

            makeBookingEvent(id, action, status, amount, changes) {
                const ts = Date.now() - Math.floor(Math.random() * 1000 * 60 * 60 * 24);
                return {
                    uid: ''be-'' + id + ''-'' + Math.random().toString(36).slice(2, 6),
                    id, action, status, amount, time: new Date(ts).toLocaleString(), ts,
                    changes: changes || {},
                    applicant: ''Applicant '' + (Math.floor(Math.random() * 50) + 1),
                    package: { name: [''Family Pack'', ''Solo Pack'', ''Couple Pack''][Math.floor(Math.random() * 3)], price: [120, 45, 80][Math.floor(Math.random() * 3)] },
                    history: [
                        { status: ''Pending'', time: new Date(ts - 1000 * 60 * 60 * 24).toLocaleString() },
                        { status: status, time: new Date(ts).toLocaleString() }
                    ]
                };
            },

            timeAgo(ts) {
                const d = Math.floor((Date.now() - ts) / 1000);
                if (d < 60) return d + ''s ago'';
                if (d < 3600) return Math.floor(d / 60) + ''m ago'';
                return Math.floor(d / 3600) + ''h ago'';
            },

            renderChart() {
                const ctx = document.getElementById(''statusChart'').getContext(''2d'');
                const days = this.lastNDays(7);
                this.chart = new Chart(ctx, {
                    type: ''bar'', data: {
                        labels: days,
                        datasets: [
                            { label: ''Pending'', data: days.map(() => this.randInt(5, 20)), backgroundColor: ''#F59E0B'' },
                            { label: ''Confirmed'', data: days.map(() => this.randInt(30, 80)), backgroundColor: ''#3B82F6'' },
                            { label: ''Cancelled'', data: days.map(() => this.randInt(1, 10)), backgroundColor: ''#F87171'' }
                        ]
                    }, options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } } }
                });
            },

            updateChartData() { },

            lastNDays(n) {
                const r = [];
                for (let i = n - 1; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    r.push(d.toISOString().slice(0, 10));
                }
                return r;
            },

            randInt(a, b) { return Math.floor(Math.random() * (b - a)) + a; }
        };
    }
</script>
}
