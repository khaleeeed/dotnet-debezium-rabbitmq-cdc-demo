@page
@model CdcDashboard.Pages.SharedModel
@{
    ViewData["Title"] = "Shared";
    ViewData["Subtitle"] = "Shared files & events";
}

<div x-data="sharedApp()" x-init="init()">
    <section class="grid grid-cols-4 gap-6 mb-6">
        <div class="col-span-3 bg-white p-4 rounded-2xl shadow">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-md font-semibold">Shared Files</h2>
                <div class="text-xs text-slate-400">Filter:
                    <select x-model="filter" class="ml-2 text-xs border rounded px-2 py-1">
                        <option value="">All</option>
                        <option value="shared">Shared</option>
                        <option value="unshared">Unshared</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <template x-for="f in files.filter(v=>!filter||v.status===filter)" :key="f.id">
                    <div class="bg-slate-50 p-3 rounded-lg border">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-sm font-semibold" x-text="f.name"></div>
                                <div class="text-xs text-slate-400">by <b x-text="f.owner"></b></div>
                            </div>
                            <div class="text-xs text-slate-500" x-text="f.status"></div>
                        </div>

                        <div class="mt-3">
                            <canvas :id="''fileSpark''+f.id" width="200" height="40"></canvas>
                        </div>

                        <div class="mt-3 text-xs text-slate-600">
                            <div>Shared with: <span class="font-medium" x-text="f.sharedWith.join('', '')"></span></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <aside class="col-span-1 bg-white p-4 rounded-2xl shadow">
            <h3 class="text-sm font-semibold mb-2">Top Sharers</h3>
            <canvas id="sharersChart" width="250" height="200"></canvas>

            <div class="mt-6">
                <h3 class="text-sm font-semibold mb-2">Recent share events</h3>
                <ul class="text-sm text-slate-600 space-y-2 max-h-[40vh] overflow-y-auto">
                    <template x-for="e in events" :key="e.uid">
                        <li class="p-2 rounded-lg bg-slate-50">
                            <div class="flex justify-between items-center">
                                <div><b x-text="e.file"></b> <span class="text-xs text-slate-400" x-text="e.action"></span></div>
                                <div class="text-xs text-slate-400" x-text="new Date(e.ts).toLocaleTimeString()"></div>
                            </div>
                            <div class="text-xs text-slate-500 mt-1">to <span x-text="e.to"></span></div>
                        </li>
                    </template>
                </ul>
            </div>
        </aside>
    </section>
</div>

@section Scripts {
<script>
    function sharedApp() {
        return {
            filter: '''',
            files: [],
            events: [],
            sharersChart: null,

            init() {
                this.files = [
                    { id: 1, name: ''contract.pdf'', owner: ''mosab'', status: ''shared'', sharedWith: [''ali'', ''sara''], spark: [1, 2, 3, 4, 3, 2, 4] },
                    { id: 2, name: ''design.png'', owner: ''mohammed'', status: ''shared'', sharedWith: [''ahmad''], spark: [2, 2, 4, 5, 4, 3, 2] },
                    { id: 3, name: ''specs.docx'', owner: ''khaled'', status: ''unshared'', sharedWith: [], spark: [0, 1, 0, 0, 1, 0, 0] }
                ];
                this.events = [
                    { uid: ''e1'', file: ''contract.pdf'', action: ''shared'', to: ''ali'', ts: Date.now() - 1000 * 60 * 20 },
                    { uid: ''e2'', file: ''design.png'', action: ''shared'', to: ''ahmad'', ts: Date.now() - 1000 * 60 * 60 }
                ];
                setTimeout(() => this.renderCharts(), 100);
                setInterval(() => this.pushEvent(), 4500);
            },

            renderCharts() {
                // file sparklines
                this.files.forEach(f => {
                    const canvas = document.getElementById(''fileSpark'' + f.id);
                    if (canvas) {
                        const ctx = canvas.getContext(''2d'');
                        new Chart(ctx, {
                            type: ''line'', data: {
                                labels: f.spark.map((_, i) => i),
                                datasets: [{ data: f.spark, borderColor: ''#60A5FA'', fill: true, backgroundColor: ''rgba(96,165,250,0.12)'', pointRadius: 0 }]
                            }, options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, maintainAspectRatio: false, responsive: false }
                        });
                    }
                });

                // top sharers
                const counts = {};
                this.files.forEach(f => f.sharedWith.forEach(u => counts[u] = (counts[u] || 0) + 1));
                const labels = Object.keys(counts);
                const data = labels.map(l => counts[l]);
                
                if (this.sharersChart) {
                    this.sharersChart.destroy();
                }
                
                const sharersCanvas = document.getElementById(''sharersChart'');
                if (sharersCanvas) {
                    this.sharersChart = new Chart(sharersCanvas.getContext(''2d''), {
                        type: ''bar'', data: { labels, datasets: [{ data, backgroundColor: ''#7C3AED'' }] },
                        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
            },

            pushEvent() {
                const sample = [
                    { file: ''contract.pdf'', action: ''shared'', to: ''mona'' },
                    { file: ''specs.docx'', action: ''shared'', to: ''sara'' },
                    { file: ''design.png'', action: ''unshared'', to: ''ahmad'' }
                ];
                const e = sample[Math.floor(Math.random() * sample.length)];
                const ev = { uid: ''ev'' + Math.random().toString(36).slice(2, 6), file: e.file, action: e.action, to: e.to, ts: Date.now() };
                this.events.unshift(ev);
                if (this.events.length > 30) this.events.pop();

                const f = this.files.find(x => x.name === e.file);
                if (e.action === ''shared'') {
                    if (f && !f.sharedWith.includes(e.to)) f.sharedWith.push(e.to);
                    if (f) f.status = ''shared'';
                } else if (e.action === ''unshared'') {
                    if (f) f.sharedWith = f.sharedWith.filter(u => u !== e.to);
                    if (f && f.sharedWith.length === 0) f.status = ''unshared'';
                }
                setTimeout(() => this.renderCharts(), 200);
            }
        };
    }
</script>
}
