<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Applicants — CDC Monitor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* subtle glow for new events */
    .pulse-new { animation: pulse 1.2s ease-out; }
    @keyframes pulse { 0% { transform: translateY(-6px); opacity:0 } 60% { transform: translateY(0); opacity:1 } 100% { transform: translateY(0); opacity:1 } }
    .diff-old { color: #94a3b8; text-decoration: line-through; }
    .diff-new { color: #0f172a; font-weight:600; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

<header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between">
  <div class="flex items-center gap-4">
    <h1 class="text-lg font-semibold">CDC Dashboard</h1>
    <nav class="text-sm text-slate-500">
      <a href="applicants.html" class="text-indigo-600 font-medium">Applicants</a>
      <a href="bookings.html" class="ml-4 hover:text-indigo-600">Bookings</a>
      <a href="packages.html" class="ml-4 hover:text-indigo-600">Packages</a>
      <a href="shared.html" class="ml-4 hover:text-indigo-600">Shared</a>
    </nav>
  </div>

  <div class="text-sm text-slate-500">Real-time • simulated feed</div>
</header>

<main class="p-6" x-data="applicantsApp()" x-init="init()">

  <!-- top summary -->
  <section class="grid grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-2xl p-4 shadow flex flex-col">
      <div class="text-xs text-slate-400">Total Applicants</div>
      <div class="text-2xl font-semibold" x-text="counts.total"></div>
      <div class="text-xs text-slate-400 mt-2">Creates / Updates / Deletes</div>
      <div class="flex gap-2 mt-2">
        <div class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700" x-text="counts.create + ' Create'"></div>
        <div class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700" x-text="counts.update + ' Update'"></div>
        <div class="text-xs px-2 py-1 rounded-full bg-rose-100 text-rose-700" x-text="counts.delete + ' Delete'"></div>
      </div>
    </div>

    <div class="bg-white rounded-2xl p-4 shadow col-span-2">
      <canvas id="createsChart" height="80"></canvas>
    </div>
  </section>

  <section class="grid grid-cols-12 gap-6">
    <!-- timeline -->
    <aside class="col-span-4 bg-white rounded-2xl p-4 shadow max-h-[70vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold">Event Timeline</h2>
        <div class="text-xs text-slate-400">Live</div>
      </div>

      <template x-for="ev in events" :key="ev.uid">
        <div
          x-on:click="select(ev)"
          :class="['group p-3 mb-3 rounded-xl transition-shadow cursor-pointer flex justify-between items-start', ev.type==='Create' ? 'border-l-4 border-emerald-500 bg-emerald-50' : (ev.type==='Update' ? 'border-l-4 border-amber-400 bg-amber-50' : 'border-l-4 border-rose-500 bg-rose-50 opacity-80 line-through')]"
          x-bind:class="ev.isNew ? 'pulse-new' : ''"
        >
          <div class="w-3/4">
            <div class="flex items-center gap-2">
              <div class="text-sm font-medium" x-text="ev.name || ('Applicant #' + ev.id)"></div>
              <div class="text-xs text-slate-500" x-text="ev.type"></div>
            </div>
            <div class="text-xs text-slate-400 mt-1" x-text="ev.time"></div>
            <div class="text-xs text-slate-500 mt-2" x-show="ev.note" x-text="ev.note"></div>
          </div>
          <div class="text-xs text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:scale-110 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </div>
      </template>
    </aside>

    <!-- inspector -->
    <section class="col-span-5 bg-white rounded-2xl p-6 shadow">
      <div class="flex justify-between items-start">
        <div>
          <h2 class="text-lg font-semibold" x-text="selected ? (selected.name || ('Applicant #' + selected.id)) : 'Inspector'"></h2>
          <p class="text-xs text-slate-400" x-text="selected ? selected.time : 'Select an event to inspect before/after values and diffs'"></p>
        </div>
        <div>
          <button class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-700" @click="clearSelection()">Clear</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-4">
        <div>
          <div class="text-xs text-slate-400 mb-2">Before</div>
          <div class="bg-slate-50 p-3 rounded-lg min-h-[120px] text-sm">
            <template x-if="selected && selected.before">
              <div>
                <template x-for="(v,k) in selected.before" :key="k">
                  <div class="mb-1">
                    <span class="text-xs text-slate-500" x-text="k + ':'"></span>
                    <span class="ml-2 diff-old" x-text="formatValue(v)"></span>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!selected || !selected.before"><div class="text-xs text-slate-400">—</div></template>
          </div>
        </div>
        <div>
          <div class="text-xs text-slate-400 mb-2">After</div>
          <div class="bg-slate-50 p-3 rounded-lg min-h-[120px] text-sm">
            <template x-if="selected && selected.after">
              <div>
                <template x-for="(v,k) in selected.after" :key="k">
                  <div class="mb-1">
                    <span class="text-xs text-slate-500" x-text="k + ':'"></span>
                    <span class="ml-2 diff-new" x-text="formatValue(v)"></span>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!selected || !selected.after"><div class="text-xs text-slate-400">—</div></template>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h3 class="text-sm font-medium mb-2">Changed Fields</h3>
        <div class="space-y-2">
          <template x-if="selected && selected.changes && Object.keys(selected.changes).length">
            <template x-for="(c,k) in selected.changes" :key="k">
              <div class="p-2 rounded-lg bg-slate-50 flex justify-between items-center">
                <div>
                  <div class="text-xs text-slate-500" x-text="k"></div>
                  <div class="text-sm"><span class="diff-old" x-text="c[0]"></span> → <span class="diff-new" x-text="c[1]"></span></div>
                </div>
                <div class="text-xs text-slate-400">{{ timestampDistance(selected.ts) }}</div>
              </div>
            </template>
          </template>
          <template x-if="!selected || !selected.changes || Object.keys(selected.changes).length === 0">
            <div class="text-xs text-slate-400">No field-level changes to display</div>
          </template>
        </div>
      </div>

      <!-- drill-down bookings -->
      <div class="mt-6" x-show="selected && selected.bookings && selected.bookings.length" x-transition>
        <h3 class="text-sm font-semibold">Bookings (drill-down)</h3>
        <template x-for="b in selected.bookings" :key="b.id">
          <div class="mt-3 p-3 rounded-lg bg-white border shadow-sm">
            <div class="flex justify-between items-center">
              <div>
                <div class="text-sm font-medium">Booking #<span x-text="b.id"></span></div>
                <div class="text-xs text-slate-400">Status: <span class="font-semibold" x-text="b.status"></span></div>
              </div>
              <div class="text-xs text-slate-400" x-text="b.date"></div>
            </div>

            <div class="mt-2 grid grid-cols-2 gap-3">
              <div class="text-xs text-slate-500">Package</div>
              <div class="text-sm font-medium" x-text="b.package.name"></div>

              <div class="text-xs text-slate-500">Price</div>
              <div class="text-sm" x-text="'$' + b.package.price"></div>

              <div class="text-xs text-slate-500">Capacity</div>
              <div class="text-sm" x-text="b.package.used + ' / ' + b.package.capacity"></div>
            </div>
          </div>
        </template>
      </div>

    </section>

    <!-- right analytics -->
    <aside class="col-span-3 bg-white rounded-2xl p-4 shadow">
      <h3 class="text-sm font-semibold mb-2">Top changed fields</h3>
      <ul class="text-sm text-slate-600 space-y-2">
        <template x-for="f in topFields" :key="f.name">
          <li class="flex justify-between items-center">
            <div><b x-text="f.name"></b> <span class="text-xs text-slate-400">({{f.count}})</span></div>
            <div class="w-24 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div class="h-2 bg-amber-400" :style="'width:' + Math.min(100, (f.count/topMax*100)) + '%'"></div>
            </div>
          </li>
        </template>
      </ul>

      <div class="mt-6">
        <h3 class="text-sm font-semibold mb-2">Live feed control</h3>
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded bg-indigo-600 text-white text-xs" @click="simulateEvent()">Push demo event</button>
          <button class="px-3 py-1 rounded bg-slate-100 text-slate-700 text-xs" @click="toggleLive()">
            <span x-text="live? 'Pause' : 'Resume'"></span>
          </button>
        </div>
      </div>
    </aside>
  </section>

</main>

<script>
  // Helper functions moved outside applicantsApp
  function makeEvent(id,type,before,after){
    const ts = Date.now() - Math.floor(Math.random()*1000*60*60*24*2);
    const name = after ? ((after.FirstName||'') + ' ' + (after.LastName||'')) : (before? ((before.FirstName||'') + ' ' + (before.LastName||'')) : null);
    const changes = (before && after) ? getChanged(before,after) : {};
    return { uid: 'ev-'+id+'-'+Math.random().toString(36).slice(2,8), id, type, before, after, changes, ts, name, time: new Date(ts).toLocaleString() };
  }
  
  function getChanged(b,a){
    const res = {};
    Object.keys({...b,...a}).forEach(k=>{
      const bv = b?b[k]:undefined; const av = a? a[k]:undefined;
      if(String(bv) !== String(av)) res[k]=[bv,av];
    });
    return res;
  }
  
  function demoBookingsFor(applicantId){
    return [
      { id:1000+applicantId, status:'Pending', date:'2025-12-18', package:{ name:'Family Pack', price:120, capacity:10, used:7 } },
      { id:2000+applicantId, status:'Confirmed', date:'2025-12-16', package:{ name:'Solo Pack', price:45, capacity:50, used:15 } }
    ];
  }

  function applicantsApp(){
    return {
      events: [],
      selected: null,
      counts: { total: 0, create:0, update:0, delete:0 },
      topFields: [],
      topMax: 1,
      live: true,
      chart: null,

      init(){
        this.seed();
        this.renderChart();
        setInterval(()=>{ if(this.live) this.simulateEvent(); }, 4200);
      },

      seed(){
        const seed = [
          makeEvent(1,'Create',{FirstName:'John',LastName:'Doe',Email:'john@example.com' }, null),
          makeEvent(2,'Create',{FirstName:'Sara',LastName:'Ahmed',Email:'sara@gmail.com' }, null),
          makeEvent(3,'Update',{FirstName:'Sara',LastName:'Ahmed',Email:'sara@gmail.com' }, {FirstName:'Sarah',LastName:'Ahmed',Email:'sarah@gmail.com'}),
          makeEvent(4,'Delete',{FirstName:'Ali',LastName:'Hassan',Email:'ali@x.com' }, null)
        ];
        seed.forEach(e => this.unshiftEvent(e));
        this.computeTopFields();
        this.updateCounts();
      },

      unshiftEvent(ev){
        ev.isNew = true;
        this.events.unshift(ev);
        if(this.events.length>80) this.events.pop();
        setTimeout(()=> ev.isNew=false, 1600);
        this.computeTopFields();
        this.updateCounts();
        this.refreshChart();
      },

      select(ev){
        this.selected = JSON.parse(JSON.stringify(ev));
        if(!this.selected.bookings) this.selected.bookings = demoBookingsFor(ev.id);
      },

      clearSelection(){ this.selected = null },

      simulateEvent(){
        const id = Math.floor(Math.random()*200)+5;
        const op = (Math.random()>0.7) ? 'Delete' : ((Math.random()>0.5)?'Update':'Create');
        const name = ['Lina','Omar','Maha','Fadi','Noor'][Math.floor(Math.random()*5)];
        let e;
        if(op==='Create') e = makeEvent(id,op,null,{FirstName:name,LastName:'User'+id,Email: name.toLowerCase()+'@ex.com'});
        else if(op==='Delete') e = makeEvent(id,op,{FirstName:name,LastName:'User'+id,Email: name.toLowerCase()+'@ex.com'}, null);
        else {
          const oldFN = name;
          const newFN = name + (Math.random()>0.5?'y':'a');
          e = makeEvent(id,op,{FirstName:oldFN,LastName:'User'+id,Email: oldFN.toLowerCase()+'@ex.com'},{FirstName:newFN,LastName:'User'+id,Email:newFN.toLowerCase()+'@ex.com'});
        }
        this.unshiftEvent(e);
      },

      toggleLive(){ this.live = !this.live },

      updateCounts(){
        this.counts.total = this.events.length;
        this.counts.create = this.events.filter(e=>e.type==='Create').length;
        this.counts.update = this.events.filter(e=>e.type==='Update').length;
        this.counts.delete = this.events.filter(e=>e.type==='Delete').length;
      },

      computeTopFields(){
        const map = {};
        this.events.forEach(e=>{
          if(e.changes){
            Object.keys(e.changes).forEach(k=> map[k] = (map[k]||0)+1);
          }
        });
        const arr = Object.keys(map).map(k=>({name:k,count:map[k]})).sort((a,b)=>b.count-a.count);
        this.topFields = arr.slice(0,6);
        this.topMax = this.topFields.length ? this.topFields[0].count : 1;
      },

      formatValue(v){ if(v===null||v===undefined) return '—'; if(typeof v==='object') return JSON.stringify(v); return String(v); },

      timestampDistance(ts){
        const d = Math.floor((Date.now() - ts)/1000);
        if(d<60) return d + 's ago';
        if(d<3600) return Math.floor(d/60) + 'm ago';
        return Math.floor(d/3600) + 'h ago';
      },

      renderChart(){
        const ctx = document.getElementById('createsChart').getContext('2d');
        this.chart = new Chart(ctx, { type:'bar', data:{ labels:[], datasets:[{ label:'Creates per day', data:[], backgroundColor:'#10B981' }]}, options:{ responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}}}}});
        this.refreshChart();
      },

      refreshChart(){
        if(!this.chart) return;  // Add this line
        const counts = {};
        this.events.forEach(e=> { if(e.type==='Create'){ const d=new Date(e.ts).toISOString().slice(0,10); counts[d]=(counts[d]||0)+1; }});
        const labels = Object.keys(counts).sort();
        this.chart.data.labels = labels;
        this.chart.data.datasets[0].data = labels.map(l=>counts[l]);
        this.chart.update();
      }
    };
  }
</script>

</body>
</html>
